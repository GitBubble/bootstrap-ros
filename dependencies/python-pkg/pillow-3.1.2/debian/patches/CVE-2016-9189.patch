Description: fix information disclosure via crafted image
Origin: upstream, https://github.com/python-pillow/Pillow/commit/c50ebe6459a131a1ea8ca531f10da616d3ceaa0f
Origin: upstream, https://github.com/python-pillow/Pillow/commit/7d6f4104a114d106cd9502e040a78e793fb72393
Origin: upstream, https://github.com/python-pillow/Pillow/commit/a662443b7f3fe394115d2eb9d71fb956b3848063
Bug: https://github.com/python-pillow/Pillow/issues/2105

Index: pillow-3.3.1/map.c
===================================================================
--- pillow-3.3.1.orig/map.c	2016-08-18 08:53:02.000000000 -0400
+++ pillow-3.3.1/map.c	2017-03-10 07:59:37.170712281 -0500
@@ -342,8 +342,18 @@
             stride = xsize * 4;
     }
 
+    if (stride > 0 && ysize > INT_MAX / stride) {
+        PyErr_SetString(PyExc_MemoryError, "Integer overflow in ysize");
+        return NULL;
+    }
+
     size = (Py_ssize_t) ysize * stride;
 
+    if (offset > PY_SSIZE_T_MAX - size) {
+        PyErr_SetString(PyExc_MemoryError, "Integer overflow in offset");
+        return NULL;
+    }
+
     /* check buffer size */
     if (PyImaging_GetBuffer(target, &view) < 0)
         return NULL;
