Backport of:

From 5d8a0be45aad78c5a22c8d099118ee26ef8144af Mon Sep 17 00:00:00 2001
From: wiredfool <eric-github@soroos.net>
Date: Sun, 25 Sep 2016 10:44:22 +0100
Subject: [PATCH] Memory error in Storage.c when accepting negative image size
 arguments

---
 Tests/images/negative_size.ppm |  1 +
 Tests/test_file_ppm.py         | 12 ++++++++++++
 libImaging/Storage.c           |  4 ++++
 3 files changed, 17 insertions(+)
 create mode 100755 Tests/images/negative_size.ppm

Index: pillow-3.1.2/Tests/images/negative_size.ppm
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ pillow-3.1.2/Tests/images/negative_size.ppm	2017-03-10 08:03:42.173428884 -0500
@@ -0,0 +1 @@
+P632 358888888632!
Index: pillow-3.1.2/Tests/test_file_ppm.py
===================================================================
--- pillow-3.1.2.orig/Tests/test_file_ppm.py	2017-03-10 08:03:42.177428928 -0500
+++ pillow-3.1.2/Tests/test_file_ppm.py	2017-03-10 08:03:42.173428884 -0500
@@ -44,6 +44,18 @@
         self.assertRaises(ValueError, lambda: Image.open(path))
 
 
+    def test_neg_ppm(self):
+        """test_neg_ppm
+
+        Storage.c accepted negative values for xsize, ysize.
+        open_ppm is a core debugging item that doesn't check any parameters for
+        sanity. 
+        """
+        
+        with self.assertRaises(ValueError):
+            Image.core.open_ppm('Tests/images/negative_size.ppm')
+
+
 if __name__ == '__main__':
     unittest.main()
 
Index: pillow-3.1.2/libImaging/Storage.c
===================================================================
--- pillow-3.1.2.orig/libImaging/Storage.c	2017-03-10 08:03:42.177428928 -0500
+++ pillow-3.1.2/libImaging/Storage.c	2017-03-10 08:09:01.648971244 -0500
@@ -386,6 +386,10 @@
     } else
         bytes = strlen(mode); /* close enough */
 
+    if (xsize < 0 || ysize < 0) {
+        return (Imaging) ImagingError_ValueError("bad image size");
+    }
+
     if ((int64_t) xsize * (int64_t) ysize * bytes <= THRESHOLD) {
         im = ImagingNewBlock(mode, xsize, ysize);
         if (im)
